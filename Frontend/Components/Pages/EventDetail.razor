@page "/events/{Slug}"
@inject Services.EventService EventService
@inject IJSRuntime JSRuntime
@using Frontend.DtoClasses
@using QRCoder
@using System.Drawing
@using Frontend.Helpers
@using ZXing
@using ZXing.Common

<PageTitle>Event Detail</PageTitle>

<h3>Event Detail</h3>

@if (eventDto == null)
{
    <p><em>Event not found or error fetching event details.</em></p>
}
else
{
    <h4>@eventDto.Name</h4>
    <p>ID: @eventDto.EventId</p>
    <button @onclick="ShowQRModal" class="btn btn-primary">Show QR Code</button>
}

<!-- Modal for QR Code -->
<div class="modal fade" id="qrModal" tabindex="-1" role="dialog" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">Event QR Code</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <img src="@qrCodeImage" alt="Event QR Code" />
        <p>URL: @qrCodeUrl</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

@code {
    [Parameter]
    public string Slug { get; set; }
    private EventDto eventDto;
    private string qrCodeUrl;
    private string qrCodeImage;

    protected override async Task OnInitializedAsync()
    {
        eventDto = await EventService.GetEventBySlug(Slug);
        if (eventDto != null)
        {
            qrCodeUrl = GenerateQRCodeUrl(eventDto.EventId.ToString());
            qrCodeImage = GenerateQRCodeImage(qrCodeUrl);
        }
    }

    private async Task ShowQRModal()
    {
        var modal = await JSRuntime.InvokeAsync<IJSObjectReference>("bootstrap.Modal.getOrCreateInstance", "#qrModal");
        await modal.InvokeVoidAsync("show");
    }

    private string GenerateQRCodeUrl(string eventId)
    {
        if (UserState.LoggedInUserId.HasValue)
        {
            return $"http://localhost:5000/api/events/register/{eventId}/{UserState.LoggedInUserId.Value}";
        }
        else
        {
            return "http://localhost:5000/login";
        }
    }

    private string GenerateQRCodeImage(string url)
    {
        // Create a barcode writer instance for QR codes
        var writer = new BarcodeWriterPixelData
        {
            Format = BarcodeFormat.QR_CODE,
            Options = new EncodingOptions
            {
                Height = 250,
                Width = 250,
                Margin = 1,
                PureBarcode = true
            }
        };

        // Generate QR code pixel data
        var pixelData = writer.Write(url);

        // Convert pixel data to Bitmap and then to a Base64 string
        using (var bitmap = new System.Drawing.Bitmap(pixelData.Width, pixelData.Height, System.Drawing.Imaging.PixelFormat.Format32bppRgb))
        {
            // Lock the bits of the bitmap
            var bitmapData = bitmap.LockBits(new System.Drawing.Rectangle(0, 0, pixelData.Width, pixelData.Height), System.Drawing.Imaging.ImageLockMode.WriteOnly, System.Drawing.Imaging.PixelFormat.Format32bppRgb);
            try
            {
                // Transfer the byte data to the bitmap
                System.Runtime.InteropServices.Marshal.Copy(pixelData.Pixels, 0, bitmapData.Scan0, pixelData.Pixels.Length);
            }
            finally
            {
                // Unlock the bits.
                bitmap.UnlockBits(bitmapData);
            }

            // Convert to base64 string
            using (var memoryStream = new System.IO.MemoryStream())
            {
                bitmap.Save(memoryStream, System.Drawing.Imaging.ImageFormat.Png);
                return $"data:image/png;base64,{Convert.ToBase64String(memoryStream.ToArray())}";
            }
        }
    }

}
